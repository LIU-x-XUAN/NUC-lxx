<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>社区健康档案管理系统 - 角色账号增加</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
    <style>
        .layui-card {border:1px solid #f2f2f2;border-radius:5px;}
        .icon {margin-right:10px;color:#1aa094;}
        .icon-blue {color:#1e9fff!important;}
        .required::before {content:"*";color:#ff0000;margin-right:4px;font-weight:bold;}
        .role-specific {display:none;}
        .permission-group {margin-bottom:15px;padding:10px;border:1px solid #e6e6e6;border-radius:4px;}
        .permission-group-title {font-weight:bold;margin-bottom:10px;color:#333;}
        .permission-items {padding-left:20px;}
        .permission-item {margin-right:15px;display:inline-block;margin-bottom:10px;}
        .form-section {margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #f2f2f2;}
        .form-section-title {font-size:16px;color:#333;margin-bottom:15px;padding-left:10px;border-left:3px solid #1E9FFF;}
        .password-strength {display:none;}
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-card">
            <div class="layui-card-header">
                <i class="fa fa-user-plus icon icon-blue"></i>角色账号增加
            </div>
            <div class="layui-card-body">
                <form class="layui-form" lay-filter="accountForm">
                    <!-- 基本信息区域 -->
                    <div class="form-section">
                        <h3 class="form-section-title">基本信息</h3>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">角色类型</label>
                            <div class="layui-input-block">
                                <select id="roleType" name="roleType" lay-verify="required" lay-filter="roleType">
                                    <option value="">请选择角色类型</option>
                                    <option value="admin">管理员</option>
                                    <option value="doctor">社区医生</option>
                                    <option value="resident">居民</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">真实姓名</label>
                            <div class="layui-input-block">
                                <input type="text" name="realName" class="layui-input" lay-verify="required"
                                lay-reqtext="真实姓名不能为空!" placeholder="请输入真实姓名">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">身份证号</label>
                            <div class="layui-input-block">
                                <input type="text" name="idCard" class="layui-input" lay-verify="required|idCard"
                                lay-reqtext="身份证号不能为空!" placeholder="请输入18位身份证号">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">手机号</label>
                            <div class="layui-input-block">
                                <input type="text" name="phone" class="layui-input" lay-verify="required|phone"
                                lay-reqtext="手机号不能为空!" placeholder="请输入11位手机号">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">电子邮箱</label>
                            <div class="layui-input-block">
                                <input type="text" name="email" class="layui-input" lay-verify="email"
                                placeholder="请输入电子邮箱">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 账号信息区域 -->
                    <div class="form-section">
                        <h3 class="form-section-title">账号信息</h3>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">登录账号</label>
                            <div class="layui-input-block">
                                <input type="text" name="username" class="layui-input" lay-verify="required|username"
                                lay-reqtext="登录账号不能为空!" placeholder="请输入4-20位字母数字组合">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">密码</label>
                            <div class="layui-input-block">
                                <input type="password" name="password" class="layui-input" lay-verify="required|password"
                                lay-reqtext="密码不能为空!" placeholder="请输入至少8位，包含大小写字母、数字和特殊符号">
                                <div class="layui-form-mid layui-word-aux password-strength">
                                    密码强度：<span class="strength-text">弱</span>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">确认密码</label>
                            <div class="layui-input-block">
                                <input type="password" name="confirmPassword" class="layui-input" lay-verify="required|confirmPassword"
                                lay-reqtext="请确认密码!">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 角色专属信息区域 -->
                    <div class="form-section">
                        <h3 class="form-section-title">角色专属信息</h3>
                        <!-- 管理员专属字段 -->
                        <div class="role-specific" id="adminFields">
                            <div class="layui-form-item">
                                <label class="layui-form-label required">管理范围</label>
                                <div class="layui-input-block">
                                    <select name="adminScope" lay-verify="required">
                                        <option value="">请选择管理范围</option>
                                        <option value="all">全部社区</option>
                                        <option value="community1">社区一</option>
                                        <option value="community2">社区二</option>
                                        <option value="community3">社区三</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">权限等级</label>
                                <div class="layui-input-block">
                                    <input type="radio" name="adminLevel" value="1" title="一级管理员" checked>
                                    <input type="radio" name="adminLevel" value="2" title="二级管理员">
                                    <input type="radio" name="adminLevel" value="3" title="三级管理员">
                                </div>
                            </div>
                        </div>
                        <!-- 社区医生专属字段 -->
                        <div class="role-specific" id="doctorFields">
                            <div class="layui-form-item">
                                <label class="layui-form-label required">所属科室</label>
                                <div class="layui-input-block">
                                    <select name="department" lay-verify="required">
                                        <option value="">请选择科室</option>
                                        <option value="internal">内科</option>
                                        <option value="surgery">外科</option>
                                        <option value="pediatrics">儿科</option>
                                        <option value="gynecology">妇科</option>
                                        <option value="preventive">预防保健科</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">执业证号</label>
                                <div class="layui-input-block">
                                    <input type="text" name="licenseNo" class="layui-input" lay-verify="required"
                                    lay-reqtext="执业证号不能为空!">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">入职日期</label>
                                <div class="layui-input-block">
                                    <input type="text" name="hireDate" class="layui-input" lay-verify="required" 
                                    lay-reqtext="入职日期不能为空!" id="hireDate">
                                </div>
                            </div>
                        </div>
                        <!-- 居民专属字段 -->
                        <div class="role-specific" id="residentFields">
                            <div class="layui-form-item">
                                <label class="layui-form-label required">居住地址</label>
                                <div class="layui-input-block">
                                    <input type="text" name="address" class="layui-input" lay-verify="required"
                                    lay-reqtext="居住地址不能为空!">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">所属社区</label>
                                <div class="layui-input-block">
                                    <select name="community" lay-verify="required">
                                        <option value="">请选择所属社区</option>
                                        <option value="community1">社区一</option>
                                        <option value="community2">社区二</option>
                                        <option value="community3">社区三</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">家庭医生</label>
                                <div class="layui-input-block">
                                    <select name="familyDoctor">
                                        <option value="">请选择家庭医生</option>
                                        <option value="doctor1">张医生</option>
                                        <option value="doctor2">李医生</option>
                                        <option value="doctor3">王医生</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 账号设置区域 -->
                    <div class="form-section">
                        <h3 class="form-section-title">账号设置</h3>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">账号状态</label>
                            <div class="layui-input-block">
                                <input type="radio" name="accountStatus" value="1" title="启用" checked>
                                <input type="radio" name="accountStatus" value="0" title="禁用">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">有效期</label>
                            <div class="layui-input-block">
                                <select name="validityPeriod" lay-verify="required" lay-filter="validityPeriod">
                                    <option value="permanent">永久有效</option>
                                    <option value="custom">自定义有效期</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item" id="customValidity" style="display:none;">
                            <label class="layui-form-label required">有效期范围</label>
                            <div class="layui-input-inline">
                                <input type="text" name="startDate" class="layui-input" id="startDate" placeholder="开始日期">
                            </div>
                            <div class="layui-form-mid">至</div>
                            <div class="layui-input-inline">
                                <input type="text" name="endDate" class="layui-input" id="endDate" placeholder="结束日期">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">登录设置</label>
                            <div class="layui-input-block">
                                <input type="checkbox" name="forceModifyPwd" lay-skin="primary" title="强制首次登录修改密码" checked>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">数据访问范围</label>
                            <div class="layui-input-block">
                                <input type="radio" name="dataScope" value="all" title="全部数据可见" checked>
                                <input type="radio" name="dataScope" value="community" title="仅限本社区数据">
                                <input type="radio" name="dataScope" value="specific" title="仅限指定人群数据">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 权限设置区域 -->
                    <div class="form-section">
                        <h3 class="form-section-title">操作权限</h3>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">权限项</label>
                            <div class="layui-input-block" id="permissionContainer">
                                <!-- 用户管理权限组 -->
                                <div class="permission-group">
                                    <div class="permission-group-title"><i class="fa fa-users"></i> 用户管理</div>
                                    <div class="permission-items">
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="用户查询" value="user_query"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="用户新增" value="user_add"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="用户编辑" value="user_edit"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="用户删除" value="user_delete"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="用户导入导出" value="user_import_export"></div>
                                    </div>
                                </div>
                                <!-- 档案管理权限组 -->
                                <div class="permission-group">
                                    <div class="permission-group-title"><i class="fa fa-file-text-o"></i> 档案管理</div>
                                    <div class="permission-items">
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="档案查询" value="record_query"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="档案新增" value="record_add"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="档案编辑" value="record_edit"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="档案删除" value="record_delete"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="档案打印" value="record_print"></div>
                                    </div>
                                </div>
                                <!-- 体检管理权限组 -->
                                <div class="permission-group">
                                    <div class="permission-group-title"><i class="fa fa-stethoscope"></i> 体检管理</div>
                                    <div class="permission-items">
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="体检预约" value="checkup_book"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="体检结果录入" value="checkup_input"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="体检报告查看" value="checkup_view"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="体检统计分析" value="checkup_analysis"></div>
                                    </div>
                                </div>
                                <!-- 慢病管理权限组 -->
                                <div class="permission-group">
                                    <div class="permission-group-title"><i class="fa fa-heartbeat"></i> 慢病管理</div>
                                    <div class="permission-items">
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="慢病患者管理" value="chronic_manage"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="随访计划制定" value="follow_plan"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="随访记录录入" value="follow_record"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="慢病统计分析" value="chronic_analysis"></div>
                                    </div>
                                </div>
                                <!-- 疫苗管理权限组 -->
                                <div class="permission-group">
                                    <div class="permission-group-title"><i class="fa fa-medkit"></i> 疫苗管理</div>
                                    <div class="permission-items">
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="疫苗接种登记" value="vaccine_record"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="接种提醒设置" value="vaccine_remind"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="疫苗库存管理" value="vaccine_stock"></div>
                                    </div>
                                </div>
                                <!-- 系统管理权限组 -->
                                <div class="permission-group">
                                    <div class="permission-group-title"><i class="fa fa-cog"></i> 系统管理</div>
                                    <div class="permission-items">
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="角色管理" value="role_manage"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="权限设置" value="permission_set"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="系统参数配置" value="system_config"></div>
                                        <div class="permission-item"><input type="checkbox" name="permission" lay-skin="primary" title="数据备份恢复" value="data_backup"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn">
                                <i class="fa fa-save"></i> 创建账号
                            </button>
                            <button class="layui-btn layui-btn-primary" type="reset">
                                <i class="fa fa-refresh"></i> 重置
                            </button>
                            <button class="layui-btn layui-btn-danger" id="cancelBtn">
                                <i class="fa fa-times"></i> 取消
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script>
    layui.use(['form', 'laydate', 'layer', 'miniTab'], function() {
        const form = layui.form;
        const laydate = layui.laydate;
        const layer = layui.layer;
        const miniTab = layui.miniTab;
        miniTab.listen();
        
        // 初始化日期选择器
        ['hireDate', 'startDate', 'endDate'].forEach(id => {
            laydate.render({elem: `#${id}`, format: 'yyyy-MM-dd', theme: 'molv'});
        });
        
        // 角色类型切换事件
        form.on('select(roleType)', function(data) {
            // 隐藏所有角色专属字段
            document.querySelectorAll('.role-specific').forEach(el => el.style.display = 'none');
            
            // 角色权限映射表
            const rolePermissions = {
                admin: [
                    'user_query', 'user_add', 'user_edit', 'user_delete', 'user_import_export',
                    'record_query', 'record_add', 'record_edit', 'record_delete', 'record_print',
                    'checkup_book', 'checkup_input', 'checkup_view', 'checkup_analysis',
                    'chronic_manage', 'follow_plan', 'follow_record', 'chronic_analysis',
                    'vaccine_record', 'vaccine_remind', 'vaccine_stock',
                    'role_manage', 'permission_set', 'system_config', 'data_backup'
                ],
                doctor: [
                    'user_query', 'record_query', 'record_add', 'record_edit', 'record_print',
                    'checkup_book', 'checkup_input', 'checkup_view', 'checkup_analysis',
                    'chronic_manage', 'follow_plan', 'follow_record', 'chronic_analysis',
                    'vaccine_record', 'vaccine_remind'
                ],
                resident: ['record_query', 'checkup_view']
            };
            
            // 显示选中角色的专属字段并设置权限
            if (data.value && rolePermissions[data.value]) {
                document.getElementById(`${data.value}Fields`).style.display = 'block';
                setRolePermissions(rolePermissions[data.value]);
            } else {
                clearAllPermissions();
            }
        });
        
        // 权限设置函数
        function setRolePermissions(permissions) {
            clearAllPermissions();
            permissions.forEach(value => {
                const checkbox = document.querySelector(`input[name="permission"][value="${value}"]`);
                if (checkbox) checkbox.checked = true;
            });
            form.render('checkbox');
        }
        
        // 清空权限函数
        function clearAllPermissions() {
            document.querySelectorAll('input[name="permission"]').forEach(cb => cb.checked = false);
            form.render('checkbox');
        }
        
        // 有效期选择事件
        form.on('select(validityPeriod)', function(data) {
            document.getElementById('customValidity').style.display = data.value === 'custom' ? 'block' : 'none';
        });
        
        // 取消按钮事件
        document.getElementById('cancelBtn').addEventListener('click', () => {
            layer.confirm('确定要取消创建账号吗？已填写的信息将不会保存。', {
                title: '提示', icon: 3, btn: ['确认', '取消']
            }, index => {
                miniTab.deleteCurrentByIframe();
                layer.close(index);
            });
        });
        
        // 密码强度检测
        const passwordInput = document.querySelector('input[name="password"]');
        const strengthContainer = document.querySelector('.password-strength');
        const strengthText = document.querySelector('.strength-text');
        
        passwordInput.addEventListener('input', function() {
            const value = this.value;
            strengthContainer.style.display = value ? 'block' : 'none';
            if (!value) return;
            
            let strength = 0;
            // 长度检测
            if (value.length >= 8) strength++;
            if (value.length >= 12) strength++;
            // 复杂度检测
            if (/[A-Z]/.test(value)) strength++;
            if (/[a-z]/.test(value)) strength++;
            if (/[0-9]/.test(value)) strength++;
            if (/[^A-Za-z0-9]/.test(value)) strength++;
            
            // 设置强度文本和颜色
            const levels = [
                {text: '弱', color: '#ff0000'},
                {text: '弱', color: '#ff0000'},
                {text: '弱', color: '#ff0000'},
                {text: '中', color: '#ff9900'},
                {text: '中', color: '#ff9900'},
                {text: '强', color: '#00cc00'}
            ];
            strengthText.textContent = levels[strength].text;
            strengthText.style.color = levels[strength].color;
        });
        
        // 表单提交事件
        form.on('submit(saveBtn)', function(data) {
            layer.confirm('确定要创建该角色账号吗？', {
                title: '确认', icon: 3, btn: ['确认', '取消']
            }, index => {
                layer.close(index);
                layer.load(2);
                
                // 模拟提交
                setTimeout(() => {
                    layer.closeAll('loading');
                    layer.msg('账号创建成功！', {icon: 1});
                    
                    setTimeout(() => {
                        layer.confirm('账号创建成功，是否继续创建新账号？', {
                            title: '操作提示', icon: 6, btn: ['继续创建', '返回列表']
                        }, idx => {
                            document.querySelector('form').reset();
                            form.render();
                            clearAllPermissions();
                            document.querySelectorAll('.role-specific').forEach(el => el.style.display = 'none');
                            layer.close(idx);
                        }, idx => {
                            miniTab.deleteCurrentByIframe();
                            layer.close(idx);
                        });
                    }, 500);
                }, 1000);
            });
            return false;
        });
        
        // 自定义验证规则
        form.verify({
            username: value => {
                if (value.length < 4 || value.length > 20) return '登录账号长度必须在4-20位之间';
                if (!/^[a-zA-Z0-9]+$/.test(value)) return '登录账号只能包含字母和数字';
            },
            password: value => {
                if (value.length < 8) return '密码长度不能少于8位';
                if (!/[A-Z]/.test(value) || !/[a-z]/.test(value) || !/[0-9]/.test(value) || !/[^A-Za-z0-9]/.test(value)) {
                    return '密码必须包含大小写字母、数字和特殊符号';
                }
            },
            confirmPassword: value => {
                if (value !== document.querySelector('input[name="password"]').value) return '两次输入的密码不一致';
            },
            idCard: value => {
                if (!/^\d{17}[\dXx]$/.test(value)) return '请输入有效的18位身份证号';
            },
            phone: value => {
                if (!/^1[3-9]\d{9}$/.test(value)) return '请输入有效的11位手机号';
            }
        });
    });
</script>
</body>
</html>
    