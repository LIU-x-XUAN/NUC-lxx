<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>体检数据手动录入与批量导入</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
    <style>
        .layui-card {border:1px solid #f2f2f2;border-radius:5px;margin-bottom:20px;}
        .layui-card-header {background-color:#fafafa;border-bottom:1px solid #f2f2f2;}
        .icon {margin-right:10px;color:#1aa094;}
        .icon-blue {color:#1e9fff!important;}
        .icon-tip {color:#ff5722!important;}
        .required::before {content:"*";color:#ff0000;margin-right:4px;font-weight:bold;}
        .form-section {padding:20px;border:1px dashed #e6e6e6;border-radius:5px;margin-bottom:20px;}
        .form-section-title {font-size:16px;color:#333;margin-bottom:15px;padding-left:10px;border-left:3px solid #1E9FFF;}
        .form-row {display:flex;margin-bottom:15px;align-items:flex-end;}
        .form-group {flex:1;margin-right:15px;}
        .form-group:last-child {margin-right:0;}
        .form-tip {color:#666;font-size:12px;margin-top:5px;}
        .reference-range {color:#666;font-size:12px;margin-left:10px;}
        .out-of-range {color:#ff0000;}
        .import-preview {max-height:300px;overflow-y:auto;margin-top:15px;}
        .btn-group {margin-top:20px;}
        .data-section {margin-top:20px;}
        .report-section {margin-top:20px;padding:15px;background-color:#f9f9f9;border-radius:5px;display:none;}
        .report-title {font-weight:bold;margin-bottom:10px;color:#1e9fff;}
        .success-count {color:#009688;}
        .fail-count {color:#ff5722;}
        .fail-reason {margin-top:10px;padding-left:20px;}
        .fail-reason li {margin-bottom:5px;}
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-card">
            <div class="layui-card-header">
                <i class="fa fa-stethoscope icon icon-blue"></i>体检数据手动录入与批量导入
            </div>
            <div class="layui-card-body">
                <form class="layui-form" lay-filter="dataEntryForm">
                    <!-- 居民选择 -->
                    <div class="form-section">
                        <h3 class="form-section-title">居民选择</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label required">选择居民</label>
                                <div class="layui-input-block">
                                    <select name="resident" lay-verify="required" lay-filter="residentSelect">
                                        <option value="">请选择需要录入数据的居民</option>
                                        <option value="1">张三 (110101199001011234)</option>
                                        <option value="2">李四 (110102199203045678)</option>
                                        <option value="3">王五 (110103198805069012)</option>
                                        <option value="4">赵六 (110104198507082345)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 数据录入方式 -->
                    <div class="form-section">
                        <h3 class="form-section-title">数据录入方式</h3>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">录入方式</label>
                            <div class="layui-input-block">
                                <input type="radio" name="entryType" value="manual" title="手动录入" checked lay-filter="entryType">
                                <input type="radio" name="entryType" value="batch" title="批量导入" lay-filter="entryType">
                            </div>
                        </div>
                        
                        <!-- 手动录入区域 -->
                        <div id="manualEntrySection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="layui-form-label">身高(cm)</label>
                                    <div class="layui-input-block">
                                        <input type="number" name="height" placeholder="请输入身高" 
                                               autocomplete="off" class="layui-input" 
                                               oninput="checkRange(this, 100, 220, '100-220cm')">
                                        <span class="reference-range">参考范围: 100-220cm</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="layui-form-label">体重(kg)</label>
                                    <div class="layui-input-block">
                                        <input type="number" name="weight" placeholder="请输入体重" 
                                               autocomplete="off" class="layui-input" step="0.1"
                                               oninput="checkRange(this, 30, 150, '30-150kg')">
                                        <span class="reference-range">参考范围: 30-150kg</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="layui-form-label">收缩压(mmHg)</label>
                                    <div class="layui-input-block">
                                        <input type="number" name="systolic" placeholder="请输入收缩压" 
                                               autocomplete="off" class="layui-input" 
                                               oninput="checkRange(this, 90, 140, '90-140mmHg')">
                                        <span class="reference-range">参考范围: 90-140mmHg</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="layui-form-label">舒张压(mmHg)</label>
                                    <div class="layui-input-block">
                                        <input type="number" name="diastolic" placeholder="请输入舒张压" 
                                               autocomplete="off" class="layui-input" 
                                               oninput="checkRange(this, 60, 90, '60-90mmHg')">
                                        <span class="reference-range">参考范围: 60-90mmHg</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="layui-form-label">空腹血糖(mmol/L)</label>
                                    <div class="layui-input-block">
                                        <input type="number" name="bloodSugar" placeholder="请输入空腹血糖" 
                                               autocomplete="off" class="layui-input" step="0.1"
                                               oninput="checkRange(this, 3.9, 6.1, '3.9-6.1mmol/L')">
                                        <span class="reference-range">参考范围: 3.9-6.1mmol/L</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="layui-form-label">总胆固醇(mmol/L)</label>
                                    <div class="layui-input-block">
                                        <input type="number" name="cholesterol" placeholder="请输入总胆固醇" 
                                               autocomplete="off" class="layui-input" step="0.01"
                                               oninput="checkRange(this, 2.9, 5.2, '2.9-5.2mmol/L')">
                                        <span class="reference-range">参考范围: 2.9-5.2mmol/L</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="layui-form-label">心电图</label>
                                    <div class="layui-input-block">
                                        <select name="ecg">
                                            <option value="">请选择心电图结果</option>
                                            <option value="normal">正常</option>
                                            <option value="sinusTachycardia">窦性心动过速</option>
                                            <option value="sinusBradycardia">窦性心动过缓</option>
                                            <option value="arrhythmia">心律不齐</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="layui-form-label">血常规</label>
                                    <div class="layui-input-block">
                                        <select name="bloodTest">
                                            <option value="">请选择血常规结果</option>
                                            <option value="normal">正常</option>
                                            <option value="abnormal">异常</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="layui-form-label">医生建议</label>
                                    <div class="layui-input-block">
                                        <textarea name="doctorAdvice" placeholder="请输入医生建议" 
                                                  class="layui-textarea" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 批量导入区域 -->
                        <div id="batchImportSection" style="display:none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="layui-form-label">选择文件</label>
                                    <div class="layui-input-block">
                                        <button type="button" class="layui-btn" id="uploadBtn">
                                            <i class="fa fa-upload"></i> 选择文件
                                        </button>
                                        <div class="layui-upload-list" id="uploadList"></div>
                                        <p class="form-tip"><i class="fa fa-info-circle icon-tip"></i> 支持对接体检设备系统，直接导入数据，格式支持：XML、CSV、Excel</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 导入后核对区域 -->
                            <div class="import-preview" id="importPreview">
                                <table class="layui-table" lay-size="sm">
                                    <thead>
                                        <tr>
                                            <th>序号</th>
                                            <th>居民姓名</th>
                                            <th>身份证号</th>
                                            <th>体检项目</th>
                                            <th>检测值</th>
                                            <th>参考范围</th>
                                            <th>状态</th>
                                        </tr>
                                    </thead>
                                    <tbody id="importDataList">
                                        <!-- 导入数据将在这里显示 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="btn-group">
                        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="confirmSubmit">
                            <i class="fa fa-check"></i> 确认提交
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary">
                            <i class="fa fa-refresh"></i> 重置
                        </button>
                    </div>
                    
                    <!-- 体检数据导入报告 -->
                    <div class="report-section" id="importReport">
                        <div class="report-title">体检数据导入报告</div>
                        <div id="reportContent"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script>
// 检查数值是否在参考范围内
function checkRange(element, min, max, rangeText) {
    const value = parseFloat($(element).val());
    const referenceEl = $(element).next('.reference-range');
    
    if (!isNaN(value)) {
        if (value < min || value > max) {
            $(element).addClass('out-of-range');
            referenceEl.addClass('out-of-range').text(`超出范围! 参考范围: ${rangeText}`);
        } else {
            $(element).removeClass('out-of-range');
            referenceEl.removeClass('out-of-range').text(`参考范围: ${rangeText}`);
        }
    } else {
        $(element).removeClass('out-of-range');
        referenceEl.removeClass('out-of-range').text(`参考范围: ${rangeText}`);
    }
}

layui.use(['form', 'layer', 'upload', 'miniTab'], function() {
    const form = layui.form;
    const layer = layui.layer;
    const upload = layui.upload;
    const $ = layui.jquery;
    layui.miniTab.listen();
    
    // 模拟居民历史数据状态
    const hasHistoryData = {
        "1": true,  // 张三有历史数据
        "2": false, // 李四无历史数据
        "3": true,  // 王五有历史数据
        "4": false  // 赵六无历史数据
    };
    
    // 监听录入方式切换
    form.on('radio(entryType)', function(data) {
        if (data.value === 'manual') {
            $('#manualEntrySection').show();
            $('#batchImportSection').hide();
        } else {
            $('#manualEntrySection').hide();
            $('#batchImportSection').show();
        }
    });
    
    // 附件上传
    const uploadInst = upload.render({
        elem: '#uploadBtn',
        url: '/upload/', // 实际项目中替换为后端上传接口
        accept: 'file',
        acceptMime: 'application/xml,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        exts: 'xml|csv|xls|xlsx',
        size: 10240, // 10MB
        multiple: false,
        auto: false, // 选择后不自动上传
        bindAction: '#confirmSubmit', // 绑定到提交按钮
        choose: function(obj) {
            // 预览所选文件
            obj.preview(function(index, file, result) {
                $('#uploadList').html(`
                    <div class="layui-upload-file">
                        <i class="fa fa-file-text-o"></i>
                        ${file.name} (${(file.size/1024).toFixed(1)}KB)
                        <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" onclick="removeUploadFile()">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                `);
                
                // 模拟导入数据预览
                setTimeout(function() {
                    const previewData = `
                    <tr>
                        <td>1</td>
                        <td>张三</td>
                        <td>110101199001011234</td>
                        <td>收缩压</td>
                        <td>135</td>
                        <td>90-140mmHg</td>
                        <td><span style="color:#009688">正常</span></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>张三</td>
                        <td>110101199001011234</td>
                        <td>舒张压</td>
                        <td>95</td>
                        <td>60-90mmHg</td>
                        <td><span style="color:#ff5722">异常</span></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>张三</td>
                        <td>110101199001011234</td>
                        <td>空腹血糖</td>
                        <td>5.8</td>
                        <td>3.9-6.1mmol/L</td>
                        <td><span style="color:#009688">正常</span></td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>李四</td>
                        <td>110102199203045678</td>
                        <td>收缩压</td>
                        <td>120</td>
                        <td>90-140mmHg</td>
                        <td><span style="color:#009688">正常</span></td>
                    </tr>`;
                    
                    $('#importDataList').html(previewData);
                    layer.msg('文件解析完成，请核对数据', {icon: 1});
                }, 1000);
            });
        },
        done: function(res) {
            // 实际项目中处理上传结果
            return true;
        }
    });
    
    // 移除上传文件
    window.removeUploadFile = function() {
        $('#uploadList').empty();
        $('#importDataList').empty();
    }
    
    // 确认提交
    form.on('submit(confirmSubmit)', function(data) {
        const residentId = data.field.resident;
        const entryType = data.field.entryType;
        const residentName = $("select[name='resident'] option:selected").text().split(' ')[0];
        
        // 检查是否选择了居民
        if (!residentId) {
            return layer.msg('请先选择居民', {icon: 2}), false;
        }
        
        // 检查批量导入是否选择了文件
        if (entryType === 'batch' && $('#uploadList').html() === '') {
            return layer.msg('请选择需要导入的文件', {icon: 2}), false;
        }
        
        // 检查是否有历史数据，确认是否覆盖
        let confirmMsg = '';
        if (hasHistoryData[residentId]) {
            confirmMsg = `检测到【${residentName}】已有历史体检数据，提交后将覆盖原有数据，是否继续？`;
        } else {
            confirmMsg = `确认提交【${residentName}】的体检数据吗？`;
        }
        
        layer.confirm(confirmMsg, {
            title: '确认提交',
            icon: 3,
            btn: ['确认', '取消']
        }, function(index) {
            layer.close(index);
            const loadIdx = layer.load(2, {shade: 0.3});
            
            setTimeout(function() {
                layer.close(loadIdx);
                
                // 生成导入报告
                let reportHtml = '';
                if (entryType === 'manual') {
                    reportHtml = `
                    <p>录入方式：手动录入</p>
                    <p>居民姓名：${residentName}</p>
                    <p>操作结果：<span class="success-count">录入成功</span></p>
                    <p>录入时间：${new Date().toLocaleString()}</p>
                    <p>提示：数据已成功保存到居民健康档案`;
                    
                    if (hasHistoryData[residentId]) {
                        reportHtml += '，原有数据已更新';
                    }
                    reportHtml += '</p>';
                } else {
                    // 批量导入报告
                    reportHtml = `
                    <p>录入方式：批量导入</p>
                    <p>导入文件：${$('#uploadList .layui-upload-file').text().split(' (')[0]}</p>
                    <p>总记录数：4 条</p>
                    <p>成功导入：<span class="success-count">3 条</span></p>
                    <p>导入失败：<span class="fail-count">1 条</span></p>
                    <p>失败原因：</p>
                    <ul class="fail-reason">
                        <li>1条记录身份证号不匹配（系统中未找到对应居民）</li>
                    </ul>
                    <p>导入时间：${new Date().toLocaleString()}</p>`;
                }
                
                $('#reportContent').html(reportHtml);
                $('#importReport').show();
                
                layer.msg('体检数据提交成功', {icon: 1, time: 1500});
            }, 1800);
        });
        
        return false;
    });
});
</script>
</body>
</html>
    