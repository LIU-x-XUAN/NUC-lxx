<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>居民基础信息与健康基线建档</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
    <style>
        .layui-card {border:1px solid #f2f2f2;border-radius:5px;margin-bottom:20px;}
        .layui-card-header {background-color:#fafafa;border-bottom:1px solid #f2f2f2;}
        .icon {margin-right:10px;color:#1aa094;}
        .icon-blue {color:#1e9fff!important;}
        .icon-tip {color:#ff5722!important;}
        .required::before {content:"*";color:#ff0000;margin-right:4px;font-weight:bold;}
        .form-section {padding:20px;border:1px dashed #e6e6e6;border-radius:5px;margin-bottom:20px;}
        .form-section-title {font-size:16px;color:#333;margin-bottom:15px;padding-left:10px;border-left:3px solid #1E9FFF;}
        .form-row {display:flex;margin-bottom:15px;}
        .form-group {flex:1;margin-right:15px;}
        .form-group:last-child {margin-right:0;}
        .form-tip {color:#666;font-size:12px;margin-top:5px;}
        .relation-item {display:flex;align-items:flex-end;padding:10px;border:1px solid #f2f2f2;border-radius:4px;margin-bottom:10px;}
        .relation-item .form-group {margin-bottom:0;}
        .relation-actions {margin-left:10px;margin-bottom:9px;}
        .btn-submit {margin-top:20px;}
        .bmi-calculator {display:inline-block;margin-left:10px;color:#1e9fff;font-size:14px;}
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-card">
            <div class="layui-card-header">
                <i class="fa fa-user-md icon icon-blue"></i>居民基础信息与健康基线建档
            </div>
            <div class="layui-card-body">
                <form class="layui-form" lay-filter="healthProfileForm">
                    <!-- 基础信息区 -->
                    <div class="form-section">
                        <h3 class="form-section-title">基础信息区</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label required">姓名</label>
                                <div class="layui-input-block">
                                    <input type="text" name="name" placeholder="请输入姓名" autocomplete="off" 
                                           class="layui-input" lay-verify="required">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="layui-form-label required">身份证号</label>
                                <div class="layui-input-block">
                                    <input type="text" name="idCard" placeholder="请输入18位身份证号" autocomplete="off" 
                                           class="layui-input" lay-verify="required|identity">
                                    <p class="form-tip"><i class="fa fa-info-circle icon-tip"></i> 系统将对身份证号进行唯一性校验</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label required">家庭住址</label>
                                <div class="layui-input-block">
                                    <input type="text" name="address" placeholder="请输入详细家庭住址" autocomplete="off" 
                                           class="layui-input" lay-verify="required">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="layui-form-label required">医保卡号</label>
                                <div class="layui-input-block">
                                    <input type="text" name="medicalCard" placeholder="请输入医保卡号" autocomplete="off" 
                                           class="layui-input" lay-verify="required">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label required">联系电话</label>
                                <div class="layui-input-block">
                                    <input type="text" name="phone" placeholder="请输入联系电话" autocomplete="off" 
                                           class="layui-input" lay-verify="required|phone">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 家庭关系区 -->
                    <div class="form-section">
                        <h3 class="form-section-title">家庭关系区</h3>
                        <div id="relationContainer">
                            <div class="relation-item" data-index="0">
                                <div class="form-group">
                                    <label class="layui-form-label">亲属姓名</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="relativeName[]" placeholder="请输入亲属姓名" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="layui-form-label">亲属身份证号</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="relativeId[]" placeholder="请输入亲属身份证号" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="layui-form-label">亲属关系</label>
                                    <div class="layui-input-block">
                                        <select name="relation[]">
                                            <option value="">请选择关系</option>
                                            <option value="spouse">配偶</option>
                                            <option value="child">子女</option>
                                            <option value="parent">父母</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="relation-actions">
                                    <button type="button" class="layui-btn layui-btn-danger layui-btn-xs delete-relation" 
                                            onclick="deleteRelation(0)" disabled>
                                        <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn layui-btn-normal" id="addRelation">
                                        <i class="fa fa-plus"></i> 新增亲属
                                    </button>
                                    <p class="form-tip">可添加多个家庭关系信息</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 健康基线区 -->
                    <div class="form-section">
                        <h3 class="form-section-title">健康基线区</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label">身高(cm)</label>
                                <div class="layui-input-block">
                                    <input type="number" name="height" placeholder="请输入身高" autocomplete="off" 
                                           class="layui-input" id="height" oninput="calculateBMI()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="layui-form-label">体重(kg)</label>
                                <div class="layui-input-block">
                                    <input type="number" name="weight" placeholder="请输入体重" autocomplete="off" 
                                           class="layui-input" id="weight" oninput="calculateBMI()">
                                    <span class="bmi-calculator" id="bmiResult"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="layui-form-label">血型</label>
                                <div class="layui-input-block">
                                    <select name="bloodType">
                                        <option value="">请选择血型</option>
                                        <option value="A">A型</option>
                                        <option value="B">B型</option>
                                        <option value="AB">AB型</option>
                                        <option value="O">O型</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label">既往病史</label>
                                <div class="layui-input-block">
                                    <textarea name="pastIllness" placeholder="请输入既往病史，无则填写'无'" 
                                              class="layui-textarea" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label">手术史</label>
                                <div class="layui-input-block">
                                    <textarea name="surgeryHistory" placeholder="请输入手术史，无则填写'无'" 
                                              class="layui-textarea" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label">过敏史</label>
                                <div class="layui-input-block">
                                    <textarea name="allergyHistory" placeholder="请输入过敏史，无则填写'无'" 
                                              class="layui-textarea" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="layui-form-label">附件上传</label>
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn" id="uploadBtn">
                                        <i class="fa fa-upload"></i> 选择文件
                                    </button>
                                    <div class="layui-upload-list" id="uploadList"></div>
                                    <p class="form-tip"><i class="fa fa-info-circle icon-tip"></i> 支持JPG、PDF格式，单个文件≤10MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="btn-submit">
                        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitProfile">
                            <i class="fa fa-save"></i> 提交建档
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary">
                            <i class="fa fa-refresh"></i> 重置
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script>
// 全局变量
let relationIndex = 1;
let uploadedFiles = [];

// BMI计算函数
function calculateBMI() {
    const height = parseFloat($('#height').val()) / 100; // 转换为米
    const weight = parseFloat($('#weight').val());
    const bmiResult = $('#bmiResult');
    
    if (height && weight && height > 0) {
        const bmi = (weight / (height * height)).toFixed(1);
        let status = '';
        
        if (bmi < 18.5) status = '偏瘦';
        else if (bmi < 24) status = '正常';
        else if (bmi < 28) status = '超重';
        else status = '肥胖';
        
        bmiResult.text(`BMI: ${bmi} (${status})`);
    } else {
        bmiResult.text('');
    }
}

// 删除亲属关系
function deleteRelation(index) {
    $(`.relation-item[data-index="${index}"]`).remove();
    // 如果只剩一项，禁用删除按钮
    if ($('.relation-item').length <= 1) {
        $('.delete-relation').attr('disabled', true);
    }
}

layui.use(['form', 'layer', 'upload', 'miniTab'], function() {
    const form = layui.form;
    const layer = layui.layer;
    const upload = layui.upload;
    const $ = layui.jquery;
    layui.miniTab.listen();
    
    // 模拟已存在的身份证号（用于唯一性校验）
    const existingIds = ['110101199001011234', '110102199203045678'];
    
    // 新增亲属关系
    $('#addRelation').click(function() {
        const html = `
        <div class="relation-item" data-index="${relationIndex}">
            <div class="form-group">
                <label class="layui-form-label">亲属姓名</label>
                <div class="layui-input-block">
                    <input type="text" name="relativeName[]" placeholder="请输入亲属姓名" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="form-group">
                <label class="layui-form-label">亲属身份证号</label>
                <div class="layui-input-block">
                    <input type="text" name="relativeId[]" placeholder="请输入亲属身份证号" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="form-group">
                <label class="layui-form-label">亲属关系</label>
                <div class="layui-input-block">
                    <select name="relation[]">
                        <option value="">请选择关系</option>
                        <option value="spouse">配偶</option>
                        <option value="child">子女</option>
                        <option value="parent">父母</option>
                    </select>
                </div>
            </div>
            <div class="relation-actions">
                <button type="button" class="layui-btn layui-btn-danger layui-btn-xs delete-relation" 
                        onclick="deleteRelation(${relationIndex})">
                    <i class="fa fa-minus"></i>
                </button>
            </div>
        </div>`;
        
        $('#relationContainer').append(html);
        form.render('select');
        // 启用所有删除按钮
        $('.delete-relation').removeAttr('disabled');
        relationIndex++;
    });
    
    // 附件上传
    const uploadInst = upload.render({
        elem: '#uploadBtn',
        url: '/upload/', // 实际项目中替换为后端上传接口
        accept: 'file',
        acceptMime: 'image/jpg,image/jpeg,application/pdf',
        exts: 'jpg|pdf',
        size: 10240, // 10MB
        multiple: true,
        auto: false, // 选择后不自动上传
        bindAction: '#submitProfile', // 绑定到提交按钮
        choose: function(obj) {
            // 预览所选文件
            obj.preview(function(index, file, result) {
                // 检查是否已添加
                if (!uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    uploadedFiles.push(file);
                    $('#uploadList').append(`
                        <div class="layui-upload-file" id="file-${index}">
                            <i class="fa ${file.type.includes('image') ? 'fa-file-image-o' : 'fa-file-pdf-o'}"></i>
                            ${file.name} (${(file.size/1024).toFixed(1)}KB)
                            <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" onclick="removeFile('file-${index}', '${file.name}')">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    `);
                }
            });
        },
        done: function(res) {
            // 实际项目中处理上传结果
            return true;
        }
    });
    
    // 移除已选文件
    window.removeFile = function(id, fileName) {
        $(`#${id}`).remove();
        uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
    }
    
    // 表单提交
    form.on('submit(submitProfile)', function(data) {
        // 身份证号唯一性校验
        if (existingIds.includes(data.field.idCard)) {
            return layer.msg('该身份证号已存在，请核对后重新输入', {icon: 2}), false;
        }
        
        // 模拟提交
        const loadIdx = layer.load(2, {shade: 0.3});
        setTimeout(function() {
            layer.close(loadIdx);
            layer.msg('居民健康档案创建成功！', {icon: 1, time: 2000}, function() {
                // 重置表单
                $('form')[0].reset();
                $('#userInfoSection').hide();
                $('#uploadList').empty();
                uploadedFiles = [];
                // 保留一个亲属关系项
                $('.relation-item:not([data-index="0"])').remove();
                $('.relation-item[data-index="0"] input').val('');
                $('.relation-item[data-index="0"] select').val('');
                $('.delete-relation').attr('disabled', true);
                relationIndex = 1;
                form.render();
            });
        }, 1500);
        
        return false;
    });
});
</script>
</body>
</html>
    